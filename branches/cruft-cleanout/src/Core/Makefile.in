# $Id$

GOAL		= libCore.a

SRCDIRS		= gnu		\
		  sched		\
		  sys		\
		  util          \
		  @extra_dirs@  
SUBDIRS		= $(SRCDIRS)


REGEX_OBJ	= gnu/regex.o
EXTRA_OBJ	= @extra_obj@
EXTRA_REG_OBJ	= @extra_reg_obj@
OBJECTS 	= gnu/GetOpt.o gnu/MLCG.o gnu/RNG.o gnu/Random.o \
		  gnu/Uniform.o gnu/hash.o gnu/error.o \
		  sched/Timer.o sched/Job.o sched/Dispatcher.o \
		  sys/Address.o sys/File.o sys/FileSet.o \
		  sys/Time.o sys/Signal.o \
		  util/Trail.o util/rusage.o util/Buffer.o util/strupr.o util/atoll.o \
		  $(EXTRA_OBJ) $(EXTRA_REG_OBJ)

#-------------------------------------------------------------------
# Paths
datarootdir	= @datarootdir@
srcdir	    	= @srcdir@
top_srcdir  	= @top_srcdir@
prefix      	= @prefix@
exec_prefix 	= @exec_prefix@
bindir      	= @bindir@
mandir      	= @mandir@
man1dir     	= $(mandir)/man1
man8dir     	= $(mandir)/man8

# Programs
@SET_MAKE@
SHELL           = /bin/sh
RANLIB          = @RANLIB@
CC              = @CC@
CXX             = @CXX@
LD              = @LD@

# Other variables
DEFINES  	= @DEFS@
CFLAGS   	= @CFLAGS@
CPPFLAGS 	= @CPPFLAGS@
LDFLAGS  	= @LDFLAGS@
CXXFLAGS 	= @CXXFLAGS@
LIBS   		= @all_LIBRARIES@ @LIBS@ @EXTRA_LIBS@
DIST_COMMON	= Makefile.in
DISTFILES	= $(DIST_COMMON)

default: all

# Implicit Rules
.y.o:

.c.o:
	@echo Compiling: `basename $<`
	@$(CC)  -c $(CPPFLAGS) $(CFLAGS) $(DEFINES) $<

.cc.o:
	@echo Compiling: `basename $<`
	$(CXX) -c $(CPPFLAGS) $(CXXFLAGS) $(DEFINES) $<

.SUFFIXES: .cc

# Making the distribution
distdir:
	@for file in `cd $(srcdir) && echo $(DISTFILES)`; do \
	  test -f $(distdir)/$$file \
	  || ln $(srcdir)/$$file $(distdir)/$$file 2> /dev/null \
	  || cp -p $(srcdir)/$$file $(distdir)/$$file; \
	done
	@for subdir in $(SUBDIRS); do		\
	  test -d $(distdir)/$$subdir		\
	  || mkdir $(distdir)/$$subdir		\
	  || exit 1;				\
	  chmod 777 $(distdir)/$$subdir;	\
	  (cd $$subdir && $(MAKE) distdir=../$(distdir)/$$subdir distdir) \
	    || exit 1; \
	done

# Other explicit Rules
all: dosrcs
	@echo "Creating library archive: $(GOAL)"
	@ar ru $(GOAL) $(OBJECTS)
	@$(RANLIB) $(GOAL)

dosrcs:
	@echo "CFLAGS=" $(CFLAGS)
	@echo "CXXFLAGS=" $(CXXFLAGS)
	@for subdir in $(SRCDIRS); do            	\
	        (cd $$subdir && $(MAKE) $(MFLAGS) all)  \
	         || case "$(MFLAGS)" in *k*) fail=yes;; *) exit 1;; esac; \
	done && test -z "$$fail"


clean:
	@for subdir in $(SUBDIRS); do            	 \
	        (cd $$subdir && $(MAKE) $(MFLAGS) clean); \
	done
	rm -f core *.o *~ $(GOAL)

mostlyclean:
	@for subdir in $(SUBDIRS); do            	 	\
	        (cd $$subdir && $(MAKE) $(MFLAGS) mostlyclean);	\
	done
	rm -f core *.o *~

depend:
	@for subdir in $(SUBDIRS); do            	 	\
	        (cd $$subdir && $(MAKE) $(MFLAGS) depend); 	\
	done

tags:
	find `pwd` -regex '.*\.[chyl][ch]?$$' | xargs etags -t

list:
	find `pwd` -name \*.hh -or -name \*.cc -or -name \*.c -or -name \*.h -or -name \*.y 
